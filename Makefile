###############################################################################
### @file	Makefile
### @brief	Simple Makefile for C projects
### @author	Jacob Adkins (jpadkins)
###############################################################################

###############################################################################
### Suppress Make output
###############################################################################
.SILENT:

###############################################################################
### Compiler flags
###############################################################################

COMP := clang
CFLAGS := -g -std=c11 -Wall -Wextra -Werror -Wconversion -pedantic

###############################################################################
### Linker flags
###############################################################################

GLFW := -lglfw
LIBS := -lm -ldl # lm for linmath, ldl for glad
GLIB := `pkg-config --libs glib-2.0`
GLIBINC := `pkg-config --cflags glib-2.0`
FREETYPE2 := `pkg-config --libs freetype2`
FREETYPE2INC := `pkg-config --cflags freetype2`
SDL2 := -lSDL2 -lSDL2_ttf -lSDL2_image -lSDL2_ttf -lSDL2_mixer
SFML := -lcsfml-system -lcsfml-window -lcsfml-graphics -lcsfml-audio \
	   -lcsfml-network

###############################################################################
### Valgrind flags
###############################################################################
VGARGS = --leak-check=full --suppressions=etc/valgrind/sdl.supp

###############################################################################
## Directories and files
###############################################################################
SRC_DIR := src
OBJ_DIR := obj
BIN_DIR := bin

BIN := $(BIN_DIR)/cproj.o
SRC_FILES := $(wildcard $(SRC_DIR)/*.c)
OBJ_FILES := $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(SRC_FILES))

###############################################################################
### Compile the project
###############################################################################

all: $(BIN)

###############################################################################
### Run the project
###############################################################################

run: $(BIN)
	$(BIN)

###############################################################################
### Generate documentation
###############################################################################

docs:
	doxygen Doxyfile

###############################################################################
### Remove binary and object files
###############################################################################

clean:
	rm -rf $(BIN) $(OBJ_FILES)

###############################################################################
### Construct the binary
###############################################################################

$(BIN): $(OBJ_FILES)
	$(COMP) $^ -o $@ $(LIBS) $(SDL2) $(GLIB)

###############################################################################
### Build the objects
###############################################################################

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	$(COMP) $(CFLAGS) -c -o $@ $^ $(GLIBINC)

###############################################################################
### Run valgrind
###############################################################################

check: $(BIN)
	valgrind $(VGARGS) $(BIN)
